<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¸ ä¹ä¹ä¹˜æ³•å¤§æŒ‘æˆ° ğŸŒ¸</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs (Compat v10) -->
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #fdf2f8;
            margin: 0;
            padding: 0;
        }
        .btn-active:active { transform: scale(0.95); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #f9a8d4; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- 1. Firebase åˆå§‹åŒ–èˆ‡ç’°å¢ƒé…ç½® ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'multiplication-master-web';

        if (!firebase.apps.length && firebaseConfig.apiKey) {
            firebase.initializeApp(firebaseConfig);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. æ ¸å¿ƒè·¯å¾‘å®šç¾© (å¿…é ˆåš´æ ¼éµå®ˆ Rule 1) ---
        // å…¬å…±æ’è¡Œæ¦œè·¯å¾‘: /artifacts/{appId}/public/data/leaderboard
        const LEADERBOARD_PATH = `artifacts/${appId}/public/data/leaderboard`;

        const REWARDS = [
            { threshold: 0, name: 'åˆå­¸è€…', icon: 'ğŸ£', color: 'bg-gray-100' },
            { threshold: 50, name: 'å°è©¦èº«æ‰‹', icon: 'ğŸ¥', color: 'bg-orange-50' },
            { threshold: 100, name: 'åº«æ´›ç±³ Kuromi', icon: 'ğŸ˜ˆ', color: 'bg-purple-100' },
            { threshold: 150, name: 'ç¾æ¨‚è’‚ My Melody', icon: 'ğŸ°', color: 'bg-pink-100' },
            { threshold: 200, name: 'å¤§è€³ç‹— Cinnamoroll', icon: 'ğŸ¶', color: 'bg-blue-50' },
            { threshold: 250, name: 'å¸ƒä¸ç‹— Pompompurin', icon: 'ğŸ®', color: 'bg-yellow-50' },
            { threshold: 300, name: 'å‡±è’‚è²“ Hello Kitty', icon: 'ğŸ±', color: 'bg-red-50' },
            { threshold: 400, name: 'é›·æ­ Leo', icon: 'ğŸ¦', color: 'bg-orange-100' },
            { threshold: 500, name: 'æ¦®è€€çš‡å† ', icon: 'ğŸ‘‘', color: 'bg-yellow-200' },
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [userName, setUserName] = useState('');
            const [gameState, setGameState] = useState('LOBBY');
            const [score, setScore] = useState(0);
            const [questionCount, setQuestionCount] = useState(0);
            const [fails, setFails] = useState(0);
            const [currentQuestion, setCurrentQuestion] = useState({ a: 0, b: 0, ans: 0 });
            const [userInput, setUserInput] = useState('');
            const [timeLeft, setTimeLeft] = useState(10);
            const [feedback, setFeedback] = useState(null);
            const [leaderboard, setLeaderboard] = useState([]);
            const [startTime, setStartTime] = useState(0);
            const isSaving = useRef(false);

            // ç™»å…¥é‚è¼¯ (Rule 3: Auth First)
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (err) {
                        console.error("Auth Error:", err);
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged(setUser);
                return () => unsubscribe();
            }, []);

            // ç›£è½æ’è¡Œæ¦œ (Rule 2: No Complex Queries)
            useEffect(() => {
                if (!user) return;
                
                const unsubscribe = db.collection(LEADERBOARD_PATH).onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // æ–¼å‰ç«¯é€²è¡Œæ’åºèˆ‡æˆªå–ï¼Œé¿å…éœ€è¦è¤‡åˆç´¢å¼•
                    const sorted = data.sort((a, b) => (b.score || 0) - (a.score || 0)).slice(0, 10);
                    setLeaderboard(sorted);
                }, (error) => {
                    console.error("Firestore Error:", error);
                });
                return () => unsubscribe();
            }, [user]);

            const generateQuestion = useCallback(() => {
                const a = Math.floor(Math.random() * 9) + 1;
                const b = Math.floor(Math.random() * 9) + 1;
                setCurrentQuestion({ a, b, ans: a * b });
                setUserInput('');
                setTimeLeft(10);
                setStartTime(Date.now());
                setFeedback(null);
            }, []);

            const endGame = async (finalScore) => {
                if (isSaving.current) return;
                isSaving.current = true;
                setGameState('GAMEOVER');
                
                // åªæœ‰åœ¨ç™»å…¥ç‹€æ…‹ä¸‹æ‰å­˜æª”
                if (user && userName.trim()) {
                    try {
                        await db.collection(LEADERBOARD_PATH).add({
                            name: userName,
                            score: finalScore,
                            uid: user.uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    } catch (e) { 
                        console.error("å­˜æª”å¤±æ•—:", e); 
                    } finally { 
                        isSaving.current = false; 
                    }
                }
            };

            const handleAnswer = (input) => {
                if (feedback) return;
                const isTimeout = input === null;
                const playerAns = parseInt(userInput);
                const isCorrect = !isTimeout && playerAns === currentQuestion.ans;
                let currentScore = score;
                let currentFails = fails;

                if (isCorrect) {
                    const timeTaken = (Date.now() - startTime) / 1000;
                    let points = timeTaken <= 2 ? 5 : timeTaken <= 4 ? 4 : timeTaken <= 6 ? 3 : timeTaken <= 8 ? 2 : 1;
                    currentScore += points;
                    setScore(currentScore);
                    setFeedback({ type: 'PASS', text: `å¤ªæ£’äº†! +${points}` });
                } else {
                    currentFails += 1;
                    setFails(currentFails);
                    setFeedback({ type: 'FAIL', text: isTimeout ? 'è¶…æ™‚äº†!' : 'ç®—éŒ¯å•¦!' });
                }

                const nextCount = questionCount + 1;
                setQuestionCount(nextCount);
                if (currentFails >= 3 || nextCount >= 100) {
                    setTimeout(() => endGame(currentScore), 1200);
                } else {
                    setTimeout(generateQuestion, 800);
                }
            };

            useEffect(() => {
                let timer;
                if (gameState === 'PLAYING' && !feedback) {
                    timer = setInterval(() => {
                        setTimeLeft(prev => {
                            if (prev <= 1) { handleAnswer(null); return 0; }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timer);
            }, [gameState, feedback]);

            const onKeyPress = (num) => {
                if (feedback || gameState !== 'PLAYING') return;
                if (num === 'DEL') setUserInput(prev => prev.slice(0, -1));
                else if (num === 'OK') { if (userInput !== '') handleAnswer(userInput); }
                else if (userInput.length < 3) setUserInput(prev => prev + num);
            };

            const getRewardInfo = (s) => REWARDS.reduce((acc, curr) => (s >= curr.threshold ? curr : acc), REWARDS[0]);

            return (
                <div className="min-h-screen p-4 flex flex-col items-center justify-center">
                    <div className="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-4 border-pink-200">
                        <div className="bg-pink-400 p-4 text-white text-center">
                            <h1 className="text-2xl font-black italic">ğŸŒ¸ ä¹ä¹ä¹˜æ³•å¤§æŒ‘æˆ° ğŸŒ¸</h1>
                        </div>

                        {gameState === 'LOBBY' && (
                            <div className="p-8 flex flex-col gap-6">
                                <div className="space-y-1">
                                    <label className="text-[10px] font-bold text-pink-300 ml-2 uppercase">æ‚¨çš„å‹‡è€…ç¨±è™Ÿ</label>
                                    <input 
                                        type="text" value={userName} onChange={(e) => setUserName(e.target.value)}
                                        placeholder="è¼¸å…¥ç¨±è™Ÿ..."
                                        className="w-full border-2 border-pink-100 rounded-2xl px-4 py-3 text-center focus:outline-none focus:border-pink-400 text-lg bg-pink-50/30 shadow-inner"
                                    />
                                </div>
                                <button onClick={() => userName.trim() && (setScore(0), setQuestionCount(0), setFails(0), setGameState('PLAYING'), generateQuestion())} className="bg-pink-500 text-white font-black py-4 rounded-2xl shadow-lg text-xl btn-active transition-all">é–‹å§‹æŒ‘æˆ°</button>
                                
                                <div className="mt-4">
                                    <h2 className="font-bold text-pink-600 border-b-2 border-pink-100 mb-3 pb-1 flex items-center gap-2">ğŸ† å…¨çƒåäººæ¦œ</h2>
                                    <div className="space-y-2 max-h-48 overflow-y-auto pr-1 custom-scroll">
                                        {leaderboard.length > 0 ? leaderboard.map((entry, idx) => {
                                            const reward = getRewardInfo(entry.score);
                                            return (
                                                <div key={idx} className={`flex justify-between items-center text-sm p-3 rounded-xl ${entry.uid === user?.uid ? 'bg-pink-100 border border-pink-200' : 'bg-pink-50'}`}>
                                                    <div className="flex items-center gap-2 font-bold">
                                                        <span className="text-xl">{reward.icon}</span>
                                                        <span className="truncate max-w-[120px]">{entry.name}</span>
                                                    </div>
                                                    <span className="text-pink-600 font-black">{entry.score} åˆ†</span>
                                                </div>
                                            );
                                        }) : <p className="text-center text-gray-300 text-xs py-4 italic">å°šç„¡ç´€éŒ„ï¼Œå¿«ä¾†æ¶ä¸‹é¦–å‹ï¼</p>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {gameState === 'PLAYING' && (
                            <div className="p-6">
                                <div className="flex justify-between text-[10px] font-black mb-4 uppercase text-gray-400">
                                    <span>é¡Œæ¬¡ {questionCount + 1}/100</span>
                                    <span>ç©åˆ†: {score}</span>
                                </div>
                                <div className="flex justify-between items-center mb-6">
                                    <div className="flex gap-1">{[...Array(3)].map((_, i) => <span key={i} className={i < (3 - fails) ? "opacity-100 text-2xl" : "opacity-20 text-2xl"}>â¤ï¸</span>)}</div>
                                    <div className={`text-xl font-mono font-bold px-4 py-1 rounded-full ${timeLeft <= 3 ? 'bg-red-100 text-red-500 animate-pulse' : 'bg-gray-100'}`}>{timeLeft}s</div>
                                </div>
                                <div className="text-center h-28 flex items-center justify-center bg-gray-50 rounded-[2.5rem] border-2 border-dashed border-gray-200 mb-6">
                                    {feedback ? <div className={`text-4xl font-black animate-bounce ${feedback.type === 'PASS' ? 'text-green-500' : 'text-red-500'}`}>{feedback.text}</div> : 
                                    <div className="text-4xl font-black font-mono tracking-tighter">{currentQuestion.a} Ã— {currentQuestion.b} = <span className="text-pink-500 underline underline-offset-8">{userInput || '?'}</span></div>}
                                </div>
                                <div className="grid grid-cols-3 gap-3">
                                    {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'DEL', 0, 'OK'].map(k => (
                                        <button key={k} onClick={() => onKeyPress(k)} className={`py-4 rounded-2xl text-2xl font-black shadow-sm btn-active ${k === 'OK' ? 'bg-green-500 text-white' : k === 'DEL' ? 'bg-red-400 text-white' : 'bg-white border-2 border-gray-100 text-gray-700'}`}>{k === 'DEL' ? 'â†' : k}</button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {gameState === 'GAMEOVER' && (
                            <div className="p-8 text-center flex flex-col items-center gap-6">
                                <h2 className="text-2xl font-black text-red-500 uppercase tracking-widest">æŒ‘æˆ°çµæŸ</h2>
                                <div className="text-6xl font-black text-pink-500 drop-shadow-sm">{score} <span className="text-xs">åˆ†</span></div>
                                <div className="bg-yellow-50 p-6 rounded-[2.5rem] border-4 border-yellow-100 w-full shadow-inner">
                                    <div className="text-7xl mb-2 animate-bounce">{getRewardInfo(score).icon}</div>
                                    <p className="font-black text-xl text-yellow-800 uppercase tracking-widest">{getRewardInfo(score).name}</p>
                                </div>
                                <button onClick={() => setGameState('LOBBY')} className="w-full bg-pink-500 text-white font-black py-5 rounded-2xl text-xl shadow-lg btn-active">è¿”å›å¤§å»³</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>