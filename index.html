<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¸ ä¹ä¹ä¹˜æ³•å¤§æŒ‘æˆ° ğŸŒ¸</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs (Compat version) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-pink-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- Firebase åˆå§‹åŒ– ---
        const firebaseConfig = JSON.parse(__firebase_config); 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'multiplication-master';

        // ä½¿ç”¨ compat æ¨¡å¼åˆå§‹åŒ–
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        const REWARDS = [
            { threshold: 0, name: 'åˆå­¸è€…', icon: 'ğŸ£', color: 'bg-gray-100' },
            { threshold: 50, name: 'å°è©¦èº«æ‰‹', icon: 'ğŸ¥', color: 'bg-orange-50' },
            { threshold: 100, name: 'åº«æ´›ç±³ Kuromi', icon: 'ğŸ˜ˆ', color: 'bg-purple-100' },
            { threshold: 150, name: 'ç¾æ¨‚è’‚ My Melody', icon: 'ğŸ°', color: 'bg-pink-100' },
            { threshold: 200, name: 'å¤§è€³ç‹— Cinnamoroll', icon: 'ğŸ¶', color: 'bg-blue-50' },
            { threshold: 250, name: 'å¸ƒä¸ç‹— Pompompurin', icon: 'ğŸ®', color: 'bg-yellow-50' },
            { threshold: 300, name: 'å‡±è’‚è²“ Hello Kitty', icon: 'ğŸ±', color: 'bg-red-50' },
            { threshold: 400, name: 'é›·æ­ Leo', icon: 'ğŸ¦', color: 'bg-orange-100' },
            { threshold: 500, name: 'æ¦®è€€çš‡å† ', icon: 'ğŸ‘‘', color: 'bg-yellow-200' },
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [userName, setUserName] = useState(localStorage.getItem('saved_player_name') || '');
            const [gameState, setGameState] = useState('LOBBY');
            const [score, setScore] = useState(0);
            const [questionCount, setQuestionCount] = useState(0);
            const [fails, setFails] = useState(0);
            const [currentQuestion, setCurrentQuestion] = useState({ a: 0, b: 0, ans: 0 });
            const [userInput, setUserInput] = useState('');
            const [timeLeft, setTimeLeft] = useState(10);
            const [feedback, setFeedback] = useState(null);
            const [leaderboard, setLeaderboard] = useState([]);
            const [startTime, setStartTime] = useState(0);
            const [isSubmitting, setIsSubmitting] = useState(false);

            // 1. è™•ç†èº«ä»½é©—è­‰ (Rule 3)
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) { console.error("Auth error", e); }
                };
                initAuth();
                return auth.onAuthStateChanged(setUser);
            }, []);

            // 2. æ’è¡Œæ¦œç›£è½ (Rule 1 & 2)
            useEffect(() => {
                if (!user) return;
                
                const lbCollection = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard');
                
                const unsubscribe = lbCollection.onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const sorted = data.sort((a, b) => (b.score || 0) - (a.score || 0)).slice(0, 10);
                    setLeaderboard(sorted);
                }, (err) => {
                    console.error("Firestore snapshot error:", err);
                });

                return () => unsubscribe();
            }, [user]);

            const generateQuestion = useCallback(() => {
                const a = Math.floor(Math.random() * 9) + 1;
                const b = Math.floor(Math.random() * 9) + 1;
                setCurrentQuestion({ a, b, ans: a * b });
                setUserInput('');
                setTimeLeft(10);
                setStartTime(Date.now());
                setFeedback(null);
            }, []);

            const saveScore = async (finalScore) => {
                if (!user || !userName.trim()) return;
                setIsSubmitting(true);
                try {
                    const lbCollection = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('leaderboard');
                    await lbCollection.add({
                        name: userName.trim(),
                        score: finalScore,
                        uid: user.uid,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (e) {
                    console.error("Error adding document: ", e);
                } finally {
                    setIsSubmitting(false);
                    setGameState('GAMEOVER');
                }
            };

            const handleAnswer = (input) => {
                if (feedback) return;
                const isTimeout = input === null;
                const playerAns = parseInt(userInput);
                const isCorrect = !isTimeout && playerAns === currentQuestion.ans;
                let currentScore = score;
                let currentFails = fails;

                if (isCorrect) {
                    const timeTaken = (Date.now() - startTime) / 1000;
                    let points = timeTaken <= 2 ? 5 : timeTaken <= 4 ? 4 : timeTaken <= 6 ? 3 : timeTaken <= 8 ? 2 : 1;
                    currentScore += points;
                    setScore(currentScore);
                    setFeedback({ type: 'PASS', text: `å¤ªæ£’äº†! +${points}` });
                } else {
                    currentFails += 1;
                    setFails(currentFails);
                    setFeedback({ type: 'FAIL', text: isTimeout ? 'æ™‚é–“åˆ°ï¼' : 'ç­”éŒ¯å›‰ï¼' });
                }

                const nextCount = questionCount + 1;
                setQuestionCount(nextCount);
                
                setTimeout(() => {
                    if (currentFails >= 3 || nextCount >= 100) {
                        saveScore(currentScore);
                    } else {
                        generateQuestion();
                    }
                }, 1000);
            };

            useEffect(() => {
                let timer;
                if (gameState === 'PLAYING' && !feedback) {
                    timer = setInterval(() => {
                        setTimeLeft(prev => {
                            if (prev <= 1) { handleAnswer(null); return 0; }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timer);
            }, [gameState, feedback]);

            const onKeyPress = (num) => {
                if (feedback || gameState !== 'PLAYING') return;
                if (num === 'DEL') setUserInput(prev => prev.slice(0, -1));
                else if (num === 'OK') { if (userInput !== '') handleAnswer(userInput); }
                else if (userInput.length < 3) setUserInput(prev => prev + num);
            };

            const getRewardInfo = (s) => REWARDS.reduce((acc, curr) => (s >= curr.threshold ? curr : acc), REWARDS[0]);
            
            const startGame = () => {
                if (!userName.trim()) return;
                localStorage.setItem('saved_player_name', userName);
                setScore(0);
                setQuestionCount(0);
                setFails(0);
                setGameState('PLAYING');
                generateQuestion();
            };

            return (
                <div className="min-h-screen p-4 flex flex-col items-center justify-center">
                    <div className="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-4 border-pink-200">
                        <div className="bg-pink-400 p-5 text-white text-center">
                            <h1 className="text-2xl font-black tracking-tighter italic">ğŸŒ¸ ä¹ä¹ä¹˜æ³•å¤§æŒ‘æˆ° ğŸŒ¸</h1>
                        </div>

                        {gameState === 'LOBBY' && (
                            <div className="p-8 flex flex-col gap-6">
                                <div className="space-y-2">
                                    <p className="text-center text-gray-400 font-bold text-sm">è«‹è¼¸å…¥å‹‡è€…å§“å</p>
                                    <input 
                                        type="text" value={userName} onChange={(e) => setUserName(e.target.value)}
                                        placeholder="ä½ çš„å¤§å..."
                                        className="w-full border-4 border-pink-50 rounded-2xl px-4 py-4 text-center focus:outline-none focus:border-pink-300 text-xl font-bold shadow-inner transition-all"
                                    />
                                </div>
                                <button onClick={startGame} className="bg-pink-500 hover:bg-pink-600 text-white font-black py-5 rounded-2xl shadow-lg text-xl active:scale-95 transition-all">é–‹å§‹æŒ‘æˆ°</button>
                                
                                <div className="bg-pink-50 rounded-2xl p-4 grid grid-cols-3 gap-2">
                                    {REWARDS.slice(2, 8).map((r, i) => (
                                        <div key={i} className="flex flex-col items-center bg-white p-2 rounded-xl shadow-sm border border-pink-100">
                                            <span className="text-2xl">{r.icon}</span>
                                            <span className="text-[10px] font-bold text-gray-500 mt-1">{r.threshold}pt</span>
                                        </div>
                                    ))}
                                </div>

                                <div className="mt-2">
                                    <h2 className="font-black text-pink-600 border-b-4 border-pink-100 mb-4 pb-1 flex justify-between items-center">
                                        <span>ğŸ† å…¨çƒæ’è¡Œæ¦œ</span>
                                        <span className="text-[10px] text-gray-400 uppercase">Top 10</span>
                                    </h2>
                                    <div className="space-y-2 max-h-48 overflow-y-auto pr-1">
                                        {leaderboard.length > 0 ? leaderboard.map((entry, idx) => {
                                            const reward = getRewardInfo(entry.score);
                                            return (
                                                <div key={idx} className={`flex justify-between items-center text-sm p-3 rounded-xl ${entry.uid === user?.uid ? 'bg-pink-100 border-2 border-pink-300' : 'bg-pink-50 border border-transparent'}`}>
                                                    <div className="flex items-center gap-3">
                                                        <span className={`w-5 h-5 flex items-center justify-center rounded-full text-[10px] font-black ${idx < 3 ? 'bg-yellow-400 text-white' : 'bg-pink-200 text-pink-500'}`}>{idx + 1}</span>
                                                        <span className="text-xl">{reward.icon}</span>
                                                        <span className="font-black text-gray-700">{entry.name}</span>
                                                    </div>
                                                    <span className="text-pink-600 font-black">{entry.score} åˆ†</span>
                                                </div>
                                            );
                                        }) : (
                                            <div className="text-center py-8 text-gray-300 text-sm font-bold">é‚„æ²’æœ‰äººç•™ä¸‹ç´€éŒ„ï¼Œå¿«ä¾†æ¶ç¬¬ä¸€ï¼</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {gameState === 'PLAYING' && (
                            <div className="p-6">
                                <div className="flex justify-between text-[10px] font-black mb-4 uppercase text-gray-400 tracking-widest">
                                    <span>é€²åº¦: {questionCount + 1}/100</span>
                                    <span>å¾—åˆ†: {score}</span>
                                </div>
                                <div className="flex justify-between items-center mb-6 px-2">
                                    <div className="flex gap-1">{[...Array(3)].map((_, i) => <span key={i} className={i < (3 - fails) ? "opacity-100 text-2xl drop-shadow-sm" : "opacity-20 text-2xl"}>â¤ï¸</span>)}</div>
                                    <div className={`text-xl font-mono font-black px-5 py-1 rounded-full shadow-inner ${timeLeft <= 3 ? 'bg-red-100 text-red-500 animate-pulse' : 'bg-gray-100 text-gray-500'}`}>{timeLeft}s</div>
                                </div>
                                <div className="text-center h-32 flex items-center justify-center bg-gray-50 rounded-[2rem] border-4 border-dashed border-gray-200 mb-6 relative overflow-hidden">
                                    {feedback ? (
                                        <div className={`text-5xl font-black animate-bounce ${feedback.type === 'PASS' ? 'text-green-500' : 'text-red-500'}`}>{feedback.text}</div>
                                    ) : (
                                        <div className="text-5xl font-black font-mono tracking-tighter flex items-center gap-3">
                                            <span>{currentQuestion.a}</span>
                                            <span className="text-pink-300">Ã—</span>
                                            <span>{currentQuestion.b}</span>
                                            <span className="text-gray-300">=</span>
                                            <span className="text-pink-500 underline underline-offset-8 min-w-[60px]">{userInput || '?'}</span>
                                        </div>
                                    )}
                                </div>
                                <div className="grid grid-cols-3 gap-3">
                                    {[1, 2, 3, 4, 5, 6, 7, 8, 9, 'DEL', 0, 'OK'].map(k => (
                                        <button 
                                            key={k} 
                                            onClick={() => onKeyPress(k)} 
                                            className={`py-5 rounded-2xl text-2xl font-black shadow-md active:translate-y-1 transition-all ${
                                                k === 'OK' ? 'bg-green-500 text-white shadow-green-200' : 
                                                k === 'DEL' ? 'bg-red-400 text-white shadow-red-200' : 
                                                'bg-white border-2 border-gray-50 hover:bg-gray-50 text-gray-700'
                                            }`}
                                        >
                                            {k === 'DEL' ? 'â†' : k}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {(gameState === 'GAMEOVER' || isSubmitting) && (
                            <div className="p-10 text-center flex flex-col items-center gap-6 animate-in fade-in zoom-in duration-500">
                                {isSubmitting ? (
                                    <div className="py-20 flex flex-col items-center">
                                        <div className="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                        <p className="font-black text-pink-500">æ­£åœ¨å‚³é€åˆ†æ•¸åˆ°é›²ç«¯...</p>
                                    </div>
                                ) : (
                                    <>
                                        <h2 className="text-3xl font-black text-red-500 tracking-widest uppercase">Challenge Over</h2>
                                        <div className="text-6xl font-black text-pink-500 drop-shadow-md my-2">{score} <small className="text-xl">pt</small></div>
                                        <div className={`p-8 rounded-[2.5rem] border-8 border-white shadow-2xl w-full transform rotate-1 ${getRewardInfo(score).color}`}>
                                            <div className="text-8xl mb-4 drop-shadow-sm">{getRewardInfo(score).icon}</div>
                                            <p className="font-black text-2xl text-gray-800 uppercase tracking-widest">{getRewardInfo(score).name}</p>
                                        </div>
                                        <button 
                                            onClick={() => setGameState('LOBBY')} 
                                            className="w-full bg-pink-500 text-white font-black py-5 rounded-2xl text-xl shadow-lg hover:bg-pink-600 transition-all active:scale-95 mt-4"
                                        >
                                            è¿”å›å¤§å»³
                                        </button>
                                    </>
                                )}
                            </div>
                        )}
                    </div>
                    <footer className="mt-8 text-[10px] text-gray-400 font-bold tracking-widest text-center uppercase">
                        <p>ğŸŒ¸ Fast correct +5pts | Try to get 500pts! ğŸŒ¸</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>